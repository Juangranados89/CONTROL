generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id           String      @id @default(cuid())
  email        String      @unique
  passwordHash String
  role         String      @default("user")
  createdAt    DateTime    @default(now())
  workOrders   WorkOrder[]
}

model Vehicle {
  id                   String            @id @default(cuid())
  code                 String            @unique // CODIGO DEL EQUIPO
  plate                String            @unique // PLACA
  model                String            // MODELO / LINEA
  brand                String?           // MARCA
  owner                String?           // Propio/Tercero (filtrar solo "PROPIO")
  familiaTipologia     String?           // FAMILIA/TIPOLOGÍA (filtrar solo "CAMIONETA")
  descripcion          String?           // DESCRIPCIÓN
  serieChasis          String?           // SERIE CHASIS / VIN
  serieMotor           String?           // SERIE MOTOR
  anioModelo           String?           // AÑO MODELO
  estadoActual         String?           // ESTADO ACTUAL
  ubicacionFrente      String?           // UBICACIÓN O FRENTE DE OBRA
  mileage              Int               @default(0)
  maintenanceCycle     Int               @default(5000)
  lastMaintenance      Int?
  lastMaintenanceDate  String?
  vin                  String?
  area                 String?
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
  workOrders           WorkOrder[]
  variableHistory      VariableHistory[]
  tireMounts           TireMount[]
  tireInspections      TireInspection[]
  
  @@index([plate])
  @@index([code])
  @@index([familiaTipologia])
  @@index([owner])
}

model WorkOrder {
  otNumber              Int      @id @default(autoincrement())
  id                    String   @unique @default(cuid())
  vehicleId             String
  vehicle               Vehicle  @relation(fields: [vehicleId], references: [id])
  vehicleCode           String
  plate                 String
  vehicleModel          String
  mileage               Int
  routine               String
  routineName           String?
  items                 String?  // JSON array de tareas
  supplies              String?  // JSON array de repuestos
  status                String   @default("ABIERTA") // ABIERTA, CERRADA
  createdBy             String?
  user                  User?    @relation(fields: [createdBy], references: [id])
  createdAt             DateTime @default(now())
  creationDate          String?  // Formato DD/MM/YYYY
  closedDate            String?  // Fecha de cierre
  closedTime            String?  // Hora de cierre
  workshop              String?
  area                  String?
  vin                   String?
  signatureResponsible  String?  // Base64 PNG firma responsable
  signatureApprover     String?  // Nombre del aprobador
  signatureReceived     String?  // Base64 PNG firma recibe
  
  @@index([vehicleId])
  @@index([plate])
  @@index([status])
}

model VariableHistory {
  id          String   @id @default(cuid())
  vehicleId   String
  vehicle     Vehicle  @relation(fields: [vehicleId], references: [id])
  plate       String
  code        String
  km          Int
  date        String
  uploadDate  DateTime @default(now())
  
  @@index([vehicleId])
  @@index([plate])
  @@index([date])
}

model AuditLog {
  id        String   @id @default(cuid())
  action    String   // e.g., "VEHICLE_UPDATE", "OT_CANCEL", "OT_CLOSE"
  entity    String   // e.g., "Vehicle", "WorkOrder"
  entityId  String
  details   String?  // JSON string with changes
  userId    String?
  userEmail String?
  createdAt DateTime @default(now())

  @@index([entity, entityId])
  @@index([userId])
}

model Tire {
  id        String   @id @default(cuid())
  marking   String   @unique // MARCACION
  brand     String?
  model     String?
  dimension String?
  dot       String?
  originalDepth Float?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  mounts      TireMount[]
  inspections TireInspection[]

  @@index([marking])
}

model TireMount {
  id           String   @id @default(cuid())
  tireId       String
  vehicleId    String
  position     Int
  mountedAt    DateTime @default(now())
  unmountedAt  DateTime?
  mountedKm    Int?
  unmountedKm  Int?
  mountedHours Int?
  unmountedHours Int?
  createdAt    DateTime @default(now())

  tire    Tire    @relation(fields: [tireId], references: [id])
  vehicle Vehicle @relation(fields: [vehicleId], references: [id])

  @@index([vehicleId, position])
  @@index([tireId])
  @@index([unmountedAt])
}

model TireInspection {
  id                    String   @id @default(cuid())
  tireId                String
  vehicleId             String
  position              Int
  inspectedAt           DateTime @default(now())
  odometerKm            Int?
  hours                 Int?
  psiCold               Float?
  depthExt              Float?
  depthCen              Float?
  depthInt              Float?
  remainingMm           Float?
  wearPct               Float?

  actionRotate          Boolean  @default(false)
  actionAlign           Boolean  @default(false)
  actionRemoveFromService Boolean @default(false)

  damageCutSidewall     Boolean  @default(false)
  damageCutTread        Boolean  @default(false)
  damageWearStepped     Boolean  @default(false)
  damageRunLowPsi       Boolean  @default(false)
  damageRimHit          Boolean  @default(false)
  damageNotRecap        Boolean  @default(false)
  damageDualMismatch    Boolean  @default(false)

  notes                 String?
  createdAt             DateTime @default(now())

  tire    Tire    @relation(fields: [tireId], references: [id])
  vehicle Vehicle @relation(fields: [vehicleId], references: [id])

  @@index([vehicleId, inspectedAt])
  @@index([tireId, inspectedAt])
  @@index([vehicleId, position, inspectedAt])
}
